<!DOCTYPE html>
<html>
   <head>
      <script src="http://autobahn.s3.amazonaws.com/js/autobahn.min.js"></script>
       <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" />
       <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
       <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>

      <script>
      $(function(){
          var userName = '';
          // WAMP session object
          var sess = null;

          $( "#dialog-form" ).dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "Login": function() {
                    userName = $('#name').val();
                    initSession();
                    $( this ).dialog( "close" );
                }
            }
          });
          $( "#dialog-form" ).dialog( "open" );

          function initSession(){
             var wsuri;
             if (window.location.protocol === "file:") {
                wsuri = "ws://localhost:9000";
             } else {
                wsuri = "ws://" + window.location.hostname + ":9000";
             }

             // connect to WAMP server
             ab.connect(wsuri,

                // WAMP session was established
                function (session) {

                   sess = session;

                   console.log("Connected to " + wsuri);

                   sess.prefix("eatbullet", "http://localhost:8080/");
                   login();
                },

                // WAMP session is gone
                function (code, reason) {

                   sess = null;

                   if (code == ab.CONNECTION_UNSUPPORTED) {
                      window.location = "http://autobahn.ws/unsupportedbrowser";
                   } else {
                      console.log(reason);
                   }
                }
             );
          }

         function makeid() {
             var text = "";
             var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

             for( var i=0; i < 5; i++ )
                 text += possible.charAt(Math.floor(Math.random() * possible.length));

             return text;
         }

        function login() {
            sess.call("eatbullet:api#login", userName).then(
              function (res) {
                 console.log("RPC result: " + res);
                 $('#user').html(userName);
                 sess.subscribe("eatbullet:games", onGamesList);
              },
              function (error) {
                 console.log("RPC error: " + error.desc);
              }
            );
            //sess.subscribe("http://localhost:8080/players", onEvent);
        }

        function onGamesList(topicUri, event) {
           console.log(topicUri);
           console.log(event);
           $('#games').html(event.join(', '));
        }

        function publishEvent() {
           sess.publish("http://example.com/simple", {'foo': 'bar', 'baz': 23});
        }
      });
      </script>
   </head>
   <body>
       <div id="dialog-form" title="Create new user">
           <p class="validateTips">All form fields are required.</p>
           <form>
           <fieldset>
           <label for="name">Login</label>
           <input type="text" name="name" id="name" class="text ui-widget-content ui-corner-all" />
           </fieldset>
           </form>
       </div>

      <h1>PubSub with AutobahnJS - Example 1</h1>
      <noscript>
         <span style="color: #f00; font-weight: bold;">
            You need to turn on JavaScript.
         </span>
      </noscript>
      <button onclick="publishEvent()">Publish</button>
      <br>
      My name is <span id="user"></span>
      <div id="games"></div>
   </body>
 </html>